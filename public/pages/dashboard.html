<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../style/dashboardAdm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <title>Dashboard - CatJournal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

</head>

<body>

  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-top">
        <img class="logo-img" src="../img/logo.svg" alt="logo-cat-journal">
        <h1>CatJournal</h1>
      </div>

      <nav class="nav-sidebar">
        <ul>
          <li><a href="../pages/preQuiz.html">Quiz</a></li>
          <li><a href="../pages/ranking.html">Ranking</a></li>
          <li><a id="dash_li" href="../pages/dashboard.html">Dashboard</a></li>
          <li id="admin_manager"><a href="../pages/gestaoUsuarios.html">Gestão de usuários</a></li>

        </ul>
      </nav>

      <button class="button-sair" onclick="window.location.href='./HomePage.html'">
        <i class="fa-solid fa-right-from-bracket" style="color: #c2185b;"></i> Sair
      </button>

      <p class="reserved">© 2024 CatJournal. Todos os direitos reservados.</p>
    </aside>

    <main class="content">
      <div class="header">
        <h1>Dashboard</h1>
        <p style="color:#8b8b8b;margin-top:6px">Visão geral das principais métricas</p>
      </div>


      <section class="kpi-row">
        <div class="kpi">
          <h3>Total de Usuários</h3>
          <p id="kpiUsuarios">--</p>
        </div>

        <div class="kpi">
          <h3>Homens x Mulheres</h3>
          <p id="kpiSexo">--</p>
        </div>

        <div class="kpi">
          <h3>Média de Idade</h3>
          <p id="kpiIdade">--</p>
        </div>

        <div class="kpi">
          <h3>Total de Gatos</h3>
          <p id="kpiGatos">--</p>
        </div>
      </section>

      <section class="graficos">
        <div class="graf-card">
          <h2>Evolução - Cadastro de Usuários</h2>
          <canvas id="graficoUsuarios"></canvas>
        </div>


        <div class="graf-card">
          <h2>Gatos por Usuário </h2>
          <canvas id="graficoGatos"></canvas>
        </div>

      </section>
    </main>
  </div>

<script>
window.onload = function() {
    var userData = JSON.parse(sessionStorage.getItem("usuario"));

    var adminLi = document.getElementById("admin_manager");
    var dashboaardLi = document.getElementById("dash_li");

    if (userData.papelUsuario === "admin") {
        adminLi.style.display = "block";
        dashboaardLi.style.display = "block";
    } else {
        adminLi.style.display = "none";
        dashboaardLi.style.display = "none";
    }

    getCats().then(() => {
        getAllUsers();
    });
};

var qtdMulheres = 0;
var qtdHomens = 0;
var qtdUsuarios = 0;
var mediaDeIdade = 0;
var qtdGato = 0;

var qtdUserJaneiro = 0;
var qtdUserFevereiro = 0;
var qtdUserMarco = 0;
var qtdUserAbril = 0;
var qtdUserMaio = 0;
var qtdUserJunho = 0;
var qtdUserJulho = 0;
var qtdUserAgosto = 0;
var qtdUserSetembro = 0;
var qtdUserOutubro = 0;
var qtdUserNovembro = 0;
var qtdUserDezembro = 0;

var usuariosEGatos = [];


function getCats() {
    return fetch("http://localhost:3000/users/get-cats", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(dados => {
        usuariosEGatos = dados.data || [];
    })
    .catch(() => alert("Erro ao carregar gatos"));
}


function getAllUsers() {
    fetch("http://localhost:3000/users/get-all", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(dados => {
        if (!dados.data || dados.data.length === 0) {
            alert("Nenhum usuário encontrado!");
            return;
        }

        var lista = dados.data;

        qtdMulheres = qtdHomens = qtdGato = 0;
        mediaDeIdade = 0;

        qtdUserJaneiro = qtdUserFevereiro = qtdUserMarco = qtdUserAbril =
        qtdUserMaio = qtdUserJunho = qtdUserJulho = qtdUserAgosto =
        qtdUserSetembro = qtdUserOutubro = qtdUserNovembro = qtdUserDezembro = 0;

        for (var i = 0; i < lista.length; i++) {
            var u = lista[i];

            if (u.sexo === "Feminino") qtdMulheres++;
            if (u.sexo === "Masculino") qtdHomens++;

            // idade
            var hoje = new Date();
            var nasc = new Date(u.dtNasc);
            var idade = hoje.getFullYear() - nasc.getFullYear();
            if (
                hoje.getMonth() < nasc.getMonth() ||
                (hoje.getMonth() === nasc.getMonth() && hoje.getDate() < nasc.getDate())
            ) {
                idade--;
            }
            mediaDeIdade += idade;

            qtdGato += Number(u.qtdGato);

            // mes
            var mes = Number(u.mesCadastro);
            if (mes === 1) qtdUserJaneiro++;
            else if (mes === 2) qtdUserFevereiro++;
            else if (mes === 3) qtdUserMarco++;
            else if (mes === 4) qtdUserAbril++;
            else if (mes === 5) qtdUserMaio++;
            else if (mes === 6) qtdUserJunho++;
            else if (mes === 7) qtdUserJulho++;
            else if (mes === 8) qtdUserAgosto++;
            else if (mes === 9) qtdUserSetembro++;
            else if (mes === 10) qtdUserOutubro++;
            else if (mes === 11) qtdUserNovembro++;
            else if (mes === 12) qtdUserDezembro++;
        }

        qtdUsuarios = lista.length;
        mediaDeIdade = Math.round(mediaDeIdade / qtdUsuarios);

        // KPIs
        document.getElementById("kpiUsuarios").innerText = qtdUsuarios;
        document.getElementById("kpiSexo").innerText = qtdHomens + " | " + qtdMulheres;
        document.getElementById("kpiIdade").innerText = mediaDeIdade + " anos";
        document.getElementById("kpiGatos").innerText = qtdGato;

        criarGraficos();
    })
    .catch(() => alert("Erro ao carregar usuários"));
}


function criarGraficos() {
    var cores = { primario: '#c20459', suave: '#ec91b7' };

    // GRÁFICO: Usuários por mês
    var ctx1 = document.getElementById('graficoUsuarios').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
            datasets: [{
                data: [
                    qtdUserJaneiro, qtdUserFevereiro, qtdUserMarco, qtdUserAbril,
                    qtdUserMaio, qtdUserJunho, qtdUserJulho, qtdUserAgosto,
                    qtdUserSetembro, qtdUserOutubro, qtdUserNovembro, qtdUserDezembro
                ],
                borderColor: cores.primario,
                backgroundColor: 'rgba(194, 4, 89, 0.2)',
                borderWidth: 3,
                tension: 0.3
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });

    // GRÁFICO: Gatos por usuário
    var ctx2 = document.getElementById('graficoGatos').getContext('2d');

    var labels = usuariosEGatos.map(u => u.nome);
    var dados = usuariosEGatos.map(u => u.qtdGato);

    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: dados,
                backgroundColor: cores.suave,
                borderColor: cores.primario,
                borderWidth: 2,
                borderRadius: 10
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}
</script>


</body>

</html>