<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/img/cat-solid-full (1).svg" type="image/svg+xml">
    <link rel="stylesheet" href="../style/login.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Login</title>
</head>

<body>
    <div class="main">
        <div class="container">
            <div class="left-container">
                <h1>Que bom ter você de volta!</h1>
                <h3> A Cat Journal sentiu sua falta</h3>
            </div>
            <div class="right-container">
                <h1>Login</h1>

                <div class="Caixa-de-entrada">

                    <h4>Email</h4>
                    <input id="iptEmail" type="email" placeholder="Email"> <br>

                    <h4>Senha</h4>
                    <input id="iptSenha" type="password" placeholder="Senha"> <br>

                    <button onclick="fazerLogin()" class="button" type="submit"> Login </button>
                </div>

                <div>
                    <p> Não tem uma conta? <br>
                        <a href="./Cadastro.html"> Cadastre-se </a>
                    </p>
                </div>
            </div>
            <p id="mensagem" class="mensagem"></p>

            <script>
                function fazerLogin() {
                    const emailValor = iptEmail.value;
                    const senhaValor = iptSenha.value;

                    fetch("http://localhost:3000/users/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            email: emailValor,
                            senha: senhaValor
                        }),
                    })
                        .then(resposta => {
                            return resposta.json().then(dados => ({
                                status: resposta.status,
                                ok: resposta.ok,
                                dados: dados
                            }));
                        })
                        .then(result => {
                            const { status, ok, dados } = result;

                            if (!ok) {
                                Swal.fire({
                                    icon: "error",
                                    title: "Erro",
                                    text: dados.message || "Falha ao fazer login"
                                });
                                return;
                            }

                            Swal.fire({
                                icon: "success",
                                title: "Login realizado!",
                                text: `Bem-vindo(a), ${dados.data.nome}!`,
                                showConfirmButton: false,
                                timer: 2000
                            }).then(() => {
                                sessionStorage.setItem("usuario", JSON.stringify(dados.data));

                                if (dados.data.papelUsuario === "admin") {
                                    window.location.href = "./gestaoUsuario.html";
                                } else {
                                    window.location.href = "./perfilUsuario.html";
                                }
                            });
                        })
                        .catch(error => {
                            mensagem.textContent = "Erro ao conectar com o servidor. Verifique se a API está rodando.";
                            mensagem.className = "mensagem erro";
                            console.error("Erro:", error);
                        });
                }


            </script>


</body>

</html>