<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style/perfilUsuario.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
    <title>Perfil - Usuário</title>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-top">
            <img class="logo-img" src="../img/logo.svg" alt="logo-cat-journal">
            <h1>CatJournal</h1>
        </div>

         <nav class="nav-sidebar">
            <ul>
                <li><a class="fixar" id="perfil_li" href="../pages/perfilUsuario.html">Perfil</a></li>
                <li><a href="#">Feed</a></li>
                <li><a href="../pages/preQuiz.html">Quiz</a></li>
                <li><a id="dash_li" href="#">Dashboard</a></li>
                <li id="admin_manager"><a href="../pages/gestaoUsuarios.html">Gestão de usuários</a></li>

            </ul>
        </nav>

        <button class="button-sair" onclick="window.location.href='./HomePage.html'">
            <i class="fa-solid fa-right-from-bracket" style="color: #c2185b;"></i> Sair
        </button>

        <p class="reserved">© 2024 CatJournal. Todos os direitos reservados.</p>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Informações do Perfil</h1>
            </div>
        </header>

        <section class="user">
            <img src="../img/avatar.jpg" alt="Usuária" class="avatar">
            <span class="username">User Name</span>
            <i class="fas fa-pen edit-icon"></i>
        </section>

        <section class="dados-cadastrais">
            <div class="editar">
                <p>Email</p>
                <div class="input-container">
                    <input type="email" value="usuario@catjournal.com" disabled>
                    <i class="fas fa-pen edit-icon"></i>
                </div>
            </div>

            <div class="editar">
                <p>Quantidade de Gatos</p>
                <div class="input-container">
                    <input type="number" value="2" disabled>
                    <i class="fas fa-pen edit-icon"></i>
                </div>
            </div>

            <div class="editar">
                <p>Sexo</p>
                <div class="input-container">
                    <select disabled>
                        <option value="Feminino" selected>Feminino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <i class="fas fa-pen edit-icon"></i>
                </div>
            </div>

            <div class="editar">
                <p>Data de Nascimento</p>
                <div class="input-container">
                    <input value="1990-01-01" disabled>
                    <i class="fas fa-pen edit-icon"></i>
                </div>
            </div>
        </section>

        <section class="dados-cadastrais">
            <h6>Segurança (Senha)</h6>

            <div class="editar">
                <p>Senha Atual</p>
                <div class="input-container">
                    <input type="password" placeholder="********">
                    <button id="botao_senha" onclick="toggleSenha(this)"> <i class="fas fa-eye edit-icon"></i> </button>
                </div>
            </div>

        </section>

        <button onclick="botaoSalvar()" class="botao-salvar">SALVAR ALTERAÇÕES</button>
    </main>

    <script>
        window.onload = function () {
    const userData = JSON.parse(sessionStorage.getItem("usuario"));

    console.log(userData);

    if (!userData) {
        console.warn("Nenhum usuário no sessionStorage");
        return;
    }

    const adminLi = document.getElementById("admin_manager");
    const perfilLi = document.getElementById("perfil_li");
    const dashboaardLi = document.getElementById("dash_li");

    if (userData.papelUsuario === "admin") {
        adminLi.style.display = "block";
        perfilLi.style.display = "none";
        dashboaardLi.style.display = "block";
    } else {
        adminLi.style.display = "none";
        perfilLi.style.display = "block";
        dashboaardLi.style.display = "none";
    }
};

const usuario = JSON.parse(sessionStorage.getItem("usuario"));

const inputs = document.getElementsByTagName("input");
const selects = document.getElementsByTagName("select");
const spans = document.getElementsByTagName("span");

if (usuario) {
    inputs[0].value = usuario.email || "usuario@catjournal.com";
    inputs[1].value = usuario.qtdGato || "2";
    selects[0].value = usuario.sexo || "Feminino";
    inputs[2].value = formatarDataBrasileira(usuario.dtNasc) || "1990-01-01";
    inputs[3].value = usuario.senha;
    spans[0].textContent = usuario.nome;
}

const editIcons = document.getElementsByClassName("edit-icon");

for (let i = 0; i < editIcons.length; i++) {
    editIcons[i].addEventListener("click", function () {
        const parent = this.parentNode;
        const input = parent.getElementsByTagName("input")[0] || parent.getElementsByTagName("select")[0];
        if (input) {
            input.disabled = !input.disabled;
            if (!input.disabled) input.focus();
        }
    });
}

function formatarDataParaMysql(dataBr) {
    if (!dataBr) return null;

    const partes = dataBr.split("/");
    if (partes.length !== 3) return null;

    const [dia, mes, ano] = partes;
    return `${ano}-${mes}-${dia}`;
}

function formatarDataBrasileira(dataMysql) {
    if (!dataMysql) return "";

    const dataApenas = dataMysql.split("T")[0];
    const partes = dataApenas.split("-");

    if (partes.length !== 3) return dataMysql;

    const [ano, mes, dia] = partes;
    return `${dia}/${mes}/${ano}`;
}

function toggleSenha(botao) {
    const input = botao.parentNode.querySelector("input");
    const icone = botao.querySelector("i");

    if (input.type === "password") {
        input.type = "text";
    } else {
        input.type = "password";
    }

    icone.classList.toggle("fa-eye");
    icone.classList.toggle("fa-eye-slash");
}



function botaoSalvar() {

    const email = inputs[0].value;
    const qtdGato = inputs[1].value;
    const sexo = selects[0].value;
    const dtNasc = inputs[2].value;
    const senha = inputs[3].value;
    const nome = spans[0].textContent;

    const usuarioAtualizado = {
        userId: usuario.id,
        nome,
        email,
        qtdGato,
        sexo,
        dtNasc: formatarDataParaMysql(dtNasc),
        senha
    };

    fetch(`http://localhost:3000/users/update/${usuarioAtualizado.userId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(usuarioAtualizado)
    })
        .then(resposta => resposta.json().then(data => ({ status: resposta.status, data })))
        .then(result => {
            if (result.status === 200) {
                alert("Alterações salvas com sucesso!");
                sessionStorage.setItem("usuario", JSON.stringify(usuarioAtualizado));
            } else {
                alert("Erro ao salvar: " + result.data.message);
            }
        })
        .catch(error => {
            console.error("Erro na atualização:", error);
            alert("Erro ao conectar ao servidor.");
        });
}

    </script>