<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Quiz - CatJournal</title>
    <link rel="stylesheet" href="../style/quizTodos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-top">
            <img class="logo-img" src="../img/logo.svg" alt="logo-cat-journal">
            <h1>CatJournal</h1>
        </div>

        <nav class="nav-sidebar">
            <ul>
                <li><a class="fixar" href="../pages/preQuiz.html">Quiz</a></li>
                <li><a href="../pages/ranking.html">Ranking</a></li>
                <li><a id="dash_li" href="../pages/dashboard.html">Dashboard</a></li>

            </ul>
        </nav>

        <button class="button-sair" onclick="window.location='./homePage.html'">
            <i class="fa-solid fa-right-from-bracket" style="color: #c2185b;"></i> Sair
        </button>

        <p class="reserved">¬© 2024 CatJournal. Todos os direitos reservados.</p>
    </aside>

    <main class="content">

        <div class="quiz-card1" id="startCard">
            <h2>Quiz de Cuidados com Gatos - N√≠vel D√≠ficil</h2>
            <button class="btn-enviar1" id="btnJogar">Jogar</button>
        </div>

        <div class="quiz-card" id="quizBox" style="display:none;">
            <h2 id="tituloPergunta"></h2>
            <p id="textoPergunta"></p>
            <div class="opcoes" id="opcoesPergunta"></div>
            <button class="btn-enviar" id="btnVoltar">Voltar</button>
            <button class="btn-enviar" id="btnProximo">Pr√≥xima</button>
        </div>
    </main>
<script>
    const userData = JSON.parse(sessionStorage.getItem("usuario"));

            const dashboaardLi = document.getElementById("dash_li")
            if (userData.papelUsuario === "admin") {
                dashboaardLi.style.display = "block"
            } else {

                dashboaardLi.style.display = "none"
            }
    



        let usuario = JSON.parse(sessionStorage.getItem("usuario"));
        let userId = usuario.id;
        let quizId = 2;
        let index = 0;
        let acertos = 0;
        let bloqueado = false;


        let perguntas = [];

        const startCard = document.getElementById("startCard");
        const quizBox = document.getElementById("quizBox");
        const titulo = document.getElementById("tituloPergunta");
        const textoPergunta = document.getElementById("textoPergunta");
        const opcoes = document.getElementById("opcoesPergunta");

        const btnJogar = document.getElementById("btnJogar");
        const btnProximo = document.getElementById("btnProximo");
        const btnVoltar = document.getElementById("btnVoltar");

        function carregarQuiz() {


            fetch("/quiz/get-quiz/" + quizId, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                //o backend responde, transforma em json
                .then(resposta => resposta.json())

                // recebe o JSON j√° convertido em js
                .then(dados => {
                    if (!dados.data || dados.data.length == 0) {
                        alert("Nenhum quiz foi encontrado!")
                        return;
                    }

                    let perguntasOrganizadas = [];

                    //percore toda a lista que veio do backend
                    for (let i = 0; i < dados.data.length; i++) {

                        let item = dados.data[i];
                        let perguntaJaExiste = false;
                        let indicePergunta = -1;

                        // Verifica se a pergunta j√° est√° na lista perguntasOrganizadas
                        for (let index = 0; index < perguntasOrganizadas.length; index++) {
                            if (perguntasOrganizadas[index].id === item.perguntaId) {
                                perguntaJaExiste = true;
                                indicePergunta = index;
                                break;
                            }
                        }
                        // Se a pergunta N√ÉO existe ainda cria ela
                        if (!perguntaJaExiste) {
                            perguntasOrganizadas.push({
                                id: item.perguntaId,
                                titulo: item.pergunta,
                                opcoes: []
                            });

                            indicePergunta = perguntasOrganizadas.length - 1;
                        }
                        //adiciona a resposta dentro da pergunta correta
                        perguntasOrganizadas[indicePergunta].opcoes.push({
                            texto: item.resposta,
                            correta: item.correta == 1
                        })
                    }
                    perguntas = perguntasOrganizadas;
                })
                .catch(() => alert("Erro ao carregar quiz"));
        }


        function carregarPergunta() {
            bloqueado = false;

            // Pega a pergunta atual
            var questao = perguntas[index];
            if (!questao) return; // se n√£o existir pergunta, para a fun√ß√£o

            // Mostra o n√∫mero da pergunta e o texto
            titulo.innerHTML = "Pergunta " + (index + 1);
            textoPergunta.innerHTML = questao.titulo;


            opcoes.innerHTML = "";

            // Mostra cada op√ß√£o
            for (var i = 0; i < questao.opcoes.length; i++) {
                var opcao = questao.opcoes[i];

                // Cria o HTML da op√ß√£o e adiciona
                opcoes.innerHTML += '<label class="opcao-label">' +
                    '<input type="radio" name="questao" value="' + i + '">' +
                    opcao.texto +
                    '</label>';
            }
        }



        function validarResposta() {
            // Se j√° estiver bloqueado, n√£o faz nada
            if (bloqueado) return false;

            // Pega a op√ß√£o selecionada
            var selecionada = document.querySelector("input[name='questao']:checked");

            // Se nenhuma op√ß√£o foi selecionada, avisa e sai
            if (!selecionada) {
                alert("Selecione uma op√ß√£o!");
                return false;
            }

            // Bloqueia para n√£o selecionar novamente
            bloqueado = true;

            // Converte o valor selecionado para n√∫mero
            var resposta = parseInt(selecionada.value);

            // Pega a pergunta atual
            var questao = perguntas[index];

            // Descobre qual √© a op√ß√£o correta
            var certa = -1;
            for (var i = 0; i < questao.opcoes.length; i++) {
                if (questao.opcoes[i].correta) {
                    certa = i;
                    break;
                }
            }

            // Pega todos os labels das op√ß√µes
            var labels = document.querySelectorAll(".opcao-label");

            // Marca as cores: verde para correta, vermelho para errada
            for (var i = 0; i < labels.length; i++) {
                if (i === certa) {
                    labels[i].style.background = "#c8e6c9"; // verde claro
                    labels[i].style.border = "2px solid #2e7d32"; // verde escuro
                }
                if (i === resposta && resposta !== certa) {
                    labels[i].style.background = "#ffcdd2"; // vermelho claro
                    labels[i].style.border = "2px solid #c62828"; // vermelho escuro
                }
            }

            // Se acertou, soma 1 aos acertos
            if (resposta === certa) {
                acertos++;
            }

            return true;
        }

        btnJogar.onclick = function () {
            if (perguntas.length === 0) {
                alert("O quiz ainda est√° carregando, tente novamente em alguns segundos.");
                return;
            }
            startCard.style.display = "none";
            quizBox.style.display = "block";
            carregarPergunta();
        };

        btnProximo.onclick = function () {
            const respondeu = validarResposta();
            if (!respondeu) return;

            setTimeout(() => {
                index++;
                if (index >= perguntas.length) {
                    quizBox.innerHTML = `
                <h2>Quiz Finalizado!</h2>
                <p>Voc√™ acertou <strong>${acertos}</strong> de <strong>${perguntas.length}</strong> perguntas! üéâüê±</p>
                <button class="btn-enviar" onclick="window.location.href='../pages/ranking.html'">
                    Ver Ranking
                </button>
            `;
                    enviarPontuacao(userId, quizId, acertos)
                    return;
                }
                carregarPergunta();
            }, 500);
        };

        btnVoltar.onclick = function () {
            if (index > 0) {
                index--;
                carregarPergunta();
            }
        };

        function enviarPontuacao(idUsuario, idQuiz, totalPontuacao) {
            fetch("/score/pontuar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idUsuario: idUsuario,
                    idQuiz: idQuiz,
                    totalPontuacao: totalPontuacao
                })
            })
                // 1. Verifica se a resposta HTTP √© OK
                .then(res => {
                    if (!res.ok) {
                        // Se a resposta for 500, lan√ßa um erro para cair no catch
                        throw new Error('Falha na inser√ß√£o da pontua√ß√£o. Status: ' + res.status);
                    }
                    return res.json();
                })
                .then(resposta => {
                    console.log("Pontua√ß√£o enviada com sucesso!", resposta);
                    carregarRanking(); // ‚úÖ Atualiza o ranking
                })
                .catch(erro => console.error("Erro ao enviar pontua√ß√£o:", erro)); // ‚úÖ Trata qualquer erro
        }


        carregarQuiz();
</script>