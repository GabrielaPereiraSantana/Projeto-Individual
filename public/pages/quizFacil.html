<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Quiz - CatJournal</title>
    <link rel="stylesheet" href="../style/quizTodos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-top">
            <img class="logo-img" src="../img/logo.svg" alt="logo-cat-journal">
            <h1>CatJournal</h1>
        </div>

        <nav class="nav-sidebar">
            <ul>
                <li><a class="fixar" id="perfil_li" href="../pages/perfilUsuario.html">Perfil</a></li>
                <li><a href="../pages/preQuiz.html">Quiz</a></li>
                <li><a href="../pages/ranking.html">Ranking</a></li>
                <li><a id="dash_li" href="../pages/dashboard.html">Dashboard</a></li>
                <li id="admin_manager"><a href="../pages/gestaoUsuarios.html">GestÃ£o de usuÃ¡rios</a></li>

            </ul>
        </nav>

        <button class="button-sair" onclick="window.location.href='./HomePage.html'">
            <i class="fa-solid fa-right-from-bracket" style="color: #c2185b;"></i> Sair
        </button>

        <p class="reserved">Â© 2024 CatJournal. Todos os direitos reservados.</p>
    </aside>

    <main class="content">

        <div class="quiz-card1" id="startCard">
            <h2>Quiz de Cuidados com Gatos - NÃ­vel FÃ¡cil</h2>
            <button class="btn-enviar1" id="btnJogar">Jogar</button>
        </div>

        <div class="quiz-card" id="quizBox" style="display:none;">
            <h2 id="tituloPergunta"></h2>
            <p id="textoPergunta"></p>
            <div class="opcoes" id="opcoesPergunta"></div>
            <button class="btn-enviar" id="btnVoltar">Voltar</button>
            <button class="btn-enviar" id="btnProximo">PrÃ³xima</button>
        </div>
    </main>
    <script>
        window.onload = () => {
            const userData = JSON.parse(sessionStorage.getItem("usuario"));

            console.log(userData)

            if (!userData) {
                console.warn("Nenhum usuÃ¡rio no sessionStorage");
                return;
            }


            const adminLi = document.getElementById("admin_manager");
            const perfilLi = document.getElementById("perfil_li");
            const dashboaardLi = document.getElementById("dash_li")
            if (userData.papelUsuario === "admin") {
                adminLi.style.display = "block";
                perfilLi.style.display = "none"
                dashboaardLi.style.display = "block"
            } else {
                adminLi.style.display = "none";
                perfilLi.style.display = "block"
                dashboaardLi.style.display = "none"
            }
        };



        let usuario = JSON.parse(sessionStorage.getItem("usuario"));
        let userId = usuario.id;
        let quizId = 1;
        let index = 0;
        let acertos = 0;
        let bloqueado = false;

        // VariÃ¡vel global para armazenar o quiz carregado
        let perguntas = [];

        const startCard = document.getElementById("startCard");
        const quizBox = document.getElementById("quizBox");
        const titulo = document.getElementById("tituloPergunta");
        const textoPergunta = document.getElementById("textoPergunta");
        const opcoes = document.getElementById("opcoesPergunta");

        const btnJogar = document.getElementById("btnJogar");
        const btnProximo = document.getElementById("btnProximo");
        const btnVoltar = document.getElementById("btnVoltar");

        function carregarQuiz() {
            fetch("http://localhost:3000/quiz/get-quiz/" + quizId)
                .then(response => response.json())
                .then(json => {
                    if (!json.data || json.data.length === 0) {
                        alert("Nenhum dado encontrado para o quiz.");
                        return;
                    }

                    let mapa = {};

                    json.data.forEach(item => {
                        if (!mapa[item.perguntaId]) {
                            mapa[item.perguntaId] = {
                                titulo: item.pergunta,
                                opcoes: []
                            };
                        }
                        mapa[item.perguntaId].opcoes.push({
                            texto: item.resposta,
                            correta: item.correta == 1
                        });
                    });

                    perguntas = Object.values(mapa);
                    console.log("Quiz carregado: ", perguntas);
                })
                .catch(() => alert("Erro ao carregar quiz"));
        }

    
        function carregarPergunta() {
            bloqueado = false;
            if (!perguntas[index]) return;

            const questao = perguntas[index];

            titulo.innerHTML = `Pergunta ${index + 1}`;
            textoPergunta.innerHTML = questao.titulo;

            opcoes.innerHTML = "";

            questao.opcoes.forEach((opcao, i) => {
                opcoes.innerHTML += `
            <label class="opcao-label">
                <input type="radio" name="questao" value="${i}">
                ${opcao.texto}
            </label>
        `;
            });
        }


        function validarResposta() {
            if (bloqueado) return false;

            const selecionada = document.querySelector("input[name='questao']:checked");

            if (!selecionada) {
                alert("Selecione uma opÃ§Ã£o!");
                return false;
            }

            bloqueado = true;

            const resposta = parseInt(selecionada.value);
            const questao = perguntas[index];
            const certa = questao.opcoes.findIndex(opcao => opcao.correta);

            const labels = document.querySelectorAll(".opcao-label");

            labels.forEach((lab, i) => {
                if (i === certa) {
                    lab.style.background = "#c8e6c9";
                    lab.style.border = "2px solid #2e7d32";
                }
                if (i === resposta && resposta !== certa) {
                    lab.style.background = "#ffcdd2";
                    lab.style.border = "2px solid #c62828";
                }
            });

            if (resposta === certa) acertos++;

            return true;
        }

        btnJogar.onclick = function () {
            if (perguntas.length === 0) {
                alert("O quiz ainda estÃ¡ carregando, tente novamente em alguns segundos.");
                return;
            }
            startCard.style.display = "none";
            quizBox.style.display = "block";
            carregarPergunta();
        };

        btnProximo.onclick = function () {
            const respondeu = validarResposta();
            if (!respondeu) return;

            setTimeout(() => {
                index++;
                if (index >= perguntas.length) {
                    quizBox.innerHTML = `
                <h2>Quiz Finalizado!</h2>
                <p>VocÃª acertou <strong>${acertos}</strong> de <strong>${perguntas.length}</strong> perguntas! ğŸ‰ğŸ±</p>
                <button class="btn-enviar" onclick="window.location.href='../pages/ranking.html'">
                    Ver Ranking
                </button>
            `;
                    return;
                }
                carregarPergunta();
            }, 500);
        };

        btnVoltar.onclick = function () {
            if (index > 0) {
                index--;
                carregarPergunta();
            }
        };

    
        carregarQuiz();
    </script>

    <body>

</html>